<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
:root {
    --bg-color: #f0f2f5; 
    --text-color: #1a202c; 
    --card-bg: rgba(255, 255, 255, 0.65);
    --border-color: rgba(0, 0, 0, 0.1); 
    --input-bg: rgba(255, 255, 255, 0.8);
    --aurora-opacity: 0.2;
}
html.dark {
    --bg-color: #0b1120; 
    --text-color: #e2e8f0; 
    --card-bg: rgba(23, 37, 62, 0.5);
    --border-color: rgba(255, 255, 255, 0.15); 
    --input-bg: rgba(23, 37, 62, 0.7);
    --aurora-opacity: 0.4;
}
body { 
    padding: 5px;
    font-family: 'Inter', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-color); 
}
.glass-card { 
    background-color: var(--card-bg); 
    border: 1px solid var(--border-color); 
    backdrop-filter: blur(25px); 
    -webkit-backdrop-filter: blur(25px); 
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.07); 
}
.form-input { 
    color: var(--text-color); 
    background-color: var(--input-bg); 
}
.btn {
    transition: all 0.3s ease;
}
.btn-primary:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); 
}
.icon-btn { 
    background-color: transparent; 
    border-radius: 8px; 
    padding: 8px; 
    transition: all 0.2s ease; 
}
.icon-btn:hover { 
    background-color: rgba(0,0,0,0.05); 
}
html.dark .icon-btn:hover { 
    background-color: rgba(255,255,255,0.1); 
}
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}
.modal.active {
    display: flex;
}
.modal-content {
    background: var(--bg-color);
    border-radius: 1rem;
    padding: 1.5rem;
    max-width: 90%;
    border: 1px solid var(--border-color);
}
/* Styles for Drag and Drop */
.lesson-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
    transform: scale(1.05);
}
.day-lessons-container.drag-over {
    border: 2px dashed var(--border-color);
    background-color: rgba(0,0,0,0.02);
}
html.dark .day-lessons-container.drag-over {
    background-color: rgba(255,255,255,0.02);
}
</style>
</head>
<body>

<div id="login-container" class="max-w-md mx-auto mt-20">
    <div class="glass-card p-8 rounded-3xl">
        <h1 class="text-3xl font-bold text-center mb-6">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h1>
        <form id="login-form" class="space-y-4">
            <input type="email" id="email" class="form-input w-full p-3 rounded-3xl border" placeholder="Email" required>
            <input type="password" id="password" class="form-input w-full p-3 rounded-3xl border" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button type="submit" class="w-full p-3 rounded-3xl font-semibold text-white bg-blue-600 hover:bg-blue-700 btn btn-primary">–í–æ–π—Ç–∏</button>
        </form>
    </div>
</div>

<div id="admin-dashboard" class="max-w-7xl mx-auto" style="display: none;">
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl sm:text-4xl font-bold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</h1>
            <p class="text-lg opacity-70 mt-1">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <span id="admin-email" class="font-semibold"></span></p>
        </div>
        <div class="flex gap-3">
            <button id="history-btn" class="p-3 rounded-3xl font-semibold text-white bg-green-500 hover:bg-green-600">–ò—Å—Ç–æ—Ä–∏—è</button>
            <button id="logout-btn" class="p-3 rounded-3xl font-semibold text-white bg-red-500 hover:bg-red-600">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div class="glass-card p-4 rounded-2xl mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group"><label class="block text-sm font-medium mb-2 opacity-80">–§–∞–∫—É–ª—å—Ç–µ—Ç</label><div class="flex items-center gap-2"><select id="facultySelect" class="form-input w-full p-3 rounded-3xl"></select><button class="icon-btn" onclick="openHierarchyModal('faculties')" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º–∏">‚öôÔ∏è</button></div></div>
            <div class="form-group"><label class="block text-sm font-medium mb-2 opacity-80">–ö—É—Ä—Å</label><div class="flex items-center gap-2"><select id="courseSelect" class="form-input w-full p-3 rounded-3xl"></select><button class="icon-btn" onclick="openHierarchyModal('courses')" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏">‚öôÔ∏è</button></div></div>
            <div class="form-group"><label class="block text-sm font-medium mb-2 opacity-80">–ì—Ä—É–ø–ø–∞</label><div class="flex items-center gap-2"><select id="groupSelect" class="form-input w-full p-3 rounded-3xl"></select><button class="icon-btn" onclick="openHierarchyModal('groups')" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏">‚öôÔ∏è</button></div></div>
        </div>
    </div>

    <div id="schedule-editor" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>

<div class="modal" id="hierarchyModal">
    <div class="modal-content glass-card p-6 rounded-2xl">
        <div class="flex justify-between items-center mb-4"><h3 id="hierarchyModalTitle" class="text-xl font-bold"></h3><button class="text-2xl opacity-70 hover:opacity-100" id="closeHierarchyModalBtn">&times;</button></div>
        <ul id="hierarchyModalList" class="max-h-60 overflow-y-auto mb-4"></ul>
        <div class="border-t border-[var(--border-color)] pt-4">
            <h4 id="hierarchyFormTitle" class="font-semibold mb-2">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</h4>
            <form id="hierarchyForm" class="space-y-3">
                <input type="hidden" id="hierarchyEditId">
                <input type="text" id="hierarchyItemName" class="form-input rounded-3xl p-3 w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
                <input type="text" id="hierarchyItemId" class="form-input rounded-3xl p-3 w-full" placeholder="ID" required>
                <div class="flex gap-3">
                    <button type="submit" id="addHierarchyItemBtn" class="btn bg-blue-600 w-full p-3 mt-2 rounded-3xl font-semibold text-white">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" id="cancelHierarchyEditBtn" class="btn bg-gray-500 w-full p-3 mt-2 rounded-3xl font-semibold text-white" style="display:none;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="lessonModal" class="modal">
    <div class="modal-content glass-card p-6 rounded-3xl w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 id="lessonModalTitle" class="text-xl font-bold"></h3>
            <button class="text-2xl" id="closeLessonModalBtn">&times;</button>
        </div>
        <form id="lessonForm" class="space-y-4">
            <input type="hidden" id="editingDay">
            <input type="hidden" id="editingIndex">
            <div class="grid grid-cols-2 gap-4">
                <div><label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label><input id="lessonStartTime" type="time" class="form-input w-full p-3 rounded-3xl" required></div>
                <div><label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</label><input id="lessonEndTime" type="time" class="form-input w-full p-3 rounded-3xl" required></div>
            </div>
            <div><label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label><input id="lessonAud" type="text" class="form-input w-full p-3 rounded-3xl" placeholder="–ê—É–¥–∏—Ç–æ—Ä–∏—è" required></div>
            <div><label>–ü—Ä–µ–¥–º–µ—Ç –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label><input id="lessonSubject" type="text" class="form-input w-full p-3 rounded-3xl" placeholder="–ü—Ä–µ–¥–º–µ—Ç –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å" required></div>
            <button type="submit" class="w-full p-3 mt-4 rounded-3xl font-semibold text-white bg-blue-600 hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content glass-card p-6 rounded-2xl w-full max-w-4xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
            <button class="text-2xl opacity-70 hover:opacity-100" id="closeHistoryModalBtn">&times;</button>
        </div>
        <div class="mb-4 flex flex-col md:flex-row gap-4">
            <input type="text" id="historySearch" class="form-input p-3 rounded-3xl w-full" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–µ–π—Å—Ç–≤–∏—é –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é...">
            <select id="historyFilterType" class="form-input p-3 rounded-3xl w-full md:w-auto">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="lesson_add">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—ã</option>
                <option value="lesson_edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—ã</option>
                <option value="lesson_delete">–£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—ã</option>
                <option value="lesson_reorder">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –ø–∞—Ä</option>
                <option value="hierarchy_add">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏</option>
                <option value="hierarchy_edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏</option>
                <option value="hierarchy_delete">–£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏</option>
            </select>
        </div>
        <ul id="history-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyB3_Qs3pr6OK2JvyL7ViO09aFXjjt9qygQ", authDomain: "tut-app-6aaae.firebaseapp.com", databaseURL: "https://tut-app-6aaae-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "tut-app-6aaae", storageBucket: "tut-app-6aaae.firebasestorage.app", messagingSenderId: "726613480112", appId: "1:726613480112:web:6e55cfb767ec8f6c5d6175", measurementId: "G-DZ0XNZR35S" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
let hierarchy = {}, currentSchedule = {}, currentHierarchyContext = {};
let lastAddedLessonDetails = { subject: '', aud: '' };
const $ = (selector) => document.querySelector(selector);

// --- AUTH & INIT ---
auth.onAuthStateChanged(user => {
    if (user) {
        db.ref('admins/' + user.uid).once('value', snapshot => {
            if (snapshot.exists()) {
                $('#login-container').style.display = 'none';
                $('#admin-dashboard').style.display = 'block';
                $('#admin-email').textContent = user.email;
                initDashboard();
            } else {
                showToast('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', 'error');
                auth.signOut();
            }
        });
    } else {
        $('#login-container').style.display = 'block';
        $('#admin-dashboard').style.display = 'none';
    }
});

document.addEventListener('DOMContentLoaded', () => {
    $('#login-form').addEventListener('submit', e => {
        e.preventDefault();
        auth.signInWithEmailAndPassword($('#email').value, $('#password').value)
            .catch(error => showToast(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, 'error'));
    });
    $('#logout-btn').addEventListener('click', () => auth.signOut());
});

function initDashboard() {
    db.ref('hierarchy').on('value', snapshot => {
        hierarchy = snapshot.val() || {};
        populateFaculties();
        if (window.historyEntries) renderHistoryList(); // Re-render history if hierarchy data changes
    });
    $('#facultySelect').addEventListener('change', populateCourses);
    $('#courseSelect').addEventListener('change', populateGroups);
    $('#groupSelect').addEventListener('change', handleGroupSelection);
    $('#closeLessonModalBtn').addEventListener('click', () => $('#lessonModal').classList.remove('active'));
    $('#lessonForm').addEventListener('submit', saveLesson);
    $('#closeHierarchyModalBtn').addEventListener('click', () => $('#hierarchyModal').classList.remove('active'));
    $('#hierarchyForm').addEventListener('submit', handleHierarchyFormSubmit);
    $('#cancelHierarchyEditBtn').addEventListener('click', resetHierarchyForm);
    $('#history-btn').addEventListener('click', openHistoryModal);
    $('#closeHistoryModalBtn').addEventListener('click', () => $('#historyModal').classList.remove('active'));

    $('#historySearch').addEventListener('input', renderHistoryList);
    $('#historyFilterType').addEventListener('change', renderHistoryList);

    db.ref('history').orderByChild('timestamp').limitToLast(200).on('value', snapshot => {
        window.historyEntries = [];
        snapshot.forEach(child => {
            window.historyEntries.push({ key: child.key, ...child.val() });
        });
        window.historyEntries.reverse();
        if ($('#historyModal').classList.contains('active')) {
            renderHistoryList();
        }
    });
}

// --- HISTORY MODAL ---
function openHistoryModal() {
    $('#historyModal').classList.add('active');
    renderHistoryList();
}

// ‚ú® NEW: Helper to get human-readable path from IDs
function getHumanReadablePath(pathStr) {
    if (!pathStr || !hierarchy) return pathStr;
    const [fId, cId, gId] = pathStr.split('/');
    const facultyName = hierarchy[fId]?.name || `(${fId})`;
    const courseName = hierarchy[fId]?.courses?.[cId]?.name || `(${cId})`;
    const groupName = hierarchy[fId]?.courses?.[cId]?.groups?.[gId]?.name || `(${gId})`;
    return `${facultyName} / ${courseName} / ${groupName}`;
}

function renderHistoryList() {
    const list = $('#history-list');
    const searchQuery = $('#historySearch').value.toLowerCase();
    const filterType = $('#historyFilterType').value;

    list.innerHTML = '';
    if (!window.historyEntries) {
        list.innerHTML = '<p class="text-center opacity-60">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
        return;
    }

    const filteredEntries = window.historyEntries.filter(entry => {
        const matchesSearch = (entry.user.toLowerCase().includes(searchQuery) ||
                               entry.action.toLowerCase().includes(searchQuery) ||
                               (entry.details && JSON.stringify(entry.details).toLowerCase().includes(searchQuery)));
        const matchesType = !filterType || entry.type === filterType;
        return matchesSearch && matchesType;
    });

    if (filteredEntries.length === 0) {
        list.innerHTML = '<p class="text-center opacity-60">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä—É.</p>';
        return;
    }

    filteredEntries.forEach(entry => {
        const dateStr = new Date(entry.timestamp).toLocaleString();
        let detailsHtml = '';
        if (entry.details) {
            detailsHtml = '<ul class="ml-4 text-sm opacity-80">';
            for (let [key, value] of Object.entries(entry.details)) {
                // ‚ú® UPDATED: Convert group path ID to human-readable name
                if (key.toLowerCase() === '–≥—Ä—É–ø–ø–∞' && typeof value === 'string' && value.includes('/')) {
                    value = getHumanReadablePath(value);
                }

                let colorClass = '';
                if (key.includes('—Å—Ç–∞—Ä–∞—è') || key.includes('—Å—Ç–∞—Ä–æ–µ')) colorClass = 'text-yellow-500';
                else if (key.includes('–Ω–æ–≤–∞—è') || key.includes('–Ω–æ–≤–æ–µ')) colorClass = 'text-green-500';
                else if (key.includes('—É–¥–∞–ª–µ–Ω–Ω–∞—è') || key.includes('—É–¥–∞–ª–µ–Ω–Ω—ã–π')) colorClass = 'text-red-500';

                detailsHtml += `<li class="${colorClass}"><strong>${key}:</strong> `;
                if (typeof value === 'object' && value !== null) {
                    detailsHtml += '<ul class="ml-4">';
                    for (const [subkey, subval] of Object.entries(value)) {
                        detailsHtml += `<li>${subkey}: ${subval}</li>`;
                    }
                    detailsHtml += '</ul>';
                } else {
                    detailsHtml += `${value}`;
                }
                detailsHtml += '</li>';
            }
            detailsHtml += '</ul>';
        }
        list.innerHTML += `
            <li class="p-3 border-b border-[var(--border-color)] rounded-lg bg-[var(--input-bg)]">
                <div class="flex justify-between mb-1">
                    <span class="font-semibold">${dateStr}</span>
                    <span class="opacity-70">${entry.user}</span>
                </div>
                <p class="font-medium">${entry.action}</p>
                ${detailsHtml}
            </li>`;
    });
}


// --- HIERARCHY POPULATION ---
function populateFaculties() {
    const currentVal = $('#facultySelect').value;
    const select = $('#facultySelect');
    select.innerHTML = '<option value="">–§–∞–∫—É–ª—å—Ç–µ—Ç</option>';
    for (const key in hierarchy) select.add(new Option(hierarchy[key].name, key));
    select.value = currentVal;
    populateCourses();
}

function populateCourses() {
    const currentVal = $('#courseSelect').value;
    const facultyId = $('#facultySelect').value;
    const select = $('#courseSelect');
    select.innerHTML = '<option value="">–ö—É—Ä—Å</option>';
    if (!facultyId) {
        populateGroups();
        return;
    }
    const faculty = hierarchy[facultyId];
    if (faculty && faculty.courses) {
        for (const key in faculty.courses) select.add(new Option(faculty.courses[key].name, key));
    }
    select.value = currentVal;
    populateGroups();
}

function populateGroups() {
    const currentVal = $('#groupSelect').value;
    const facultyId = $('#facultySelect').value;
    const courseId = $('#courseSelect').value;
    const select = $('#groupSelect');
    select.innerHTML = '<option value="">–ì—Ä—É–ø–ø–∞</option>';
    if (!courseId) {
        handleGroupSelection();
        return;
    }
    const course = hierarchy[facultyId]?.courses?.[courseId];
    if (course && course.groups) {
        for (const key in course.groups) select.add(new Option(course.groups[key].name, key));
    }
    select.value = currentVal;
    handleGroupSelection();
}

// Theme handling
const toggleDarkTheme = (isDark) => document.documentElement.classList.toggle('dark', isDark);
const themeMatcher = window.matchMedia('(prefers-color-scheme: dark)');
toggleDarkTheme(themeMatcher.matches);
themeMatcher.addEventListener('change', e => toggleDarkTheme(e.matches));

// --- SCHEDULE MANAGEMENT ---
function handleGroupSelection() {
    const pathIds = { f: $('#facultySelect').value, c: $('#courseSelect').value, g: $('#groupSelect').value };
    const editorDiv = $('#schedule-editor');
    if ($('#schedule-editor')._listener) {
        db.ref($('#schedule-editor')._path).off('value', $('#schedule-editor')._listener);
    }
    if (!pathIds.f || !pathIds.c || !pathIds.g) {
        currentSchedule = {};
        editorDiv.innerHTML = '<p class="text-center opacity-70 col-span-full">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.</p>';
        return;
    }
    const schedulePath = `schedules/${pathIds.f}/${pathIds.c}/${pathIds.g}`;
    const listener = snapshot => {
        currentSchedule = snapshot.val() || {};
        renderScheduleEditor();
    };
    db.ref(schedulePath).on('value', listener);
    $('#schedule-editor')._listener = listener;
    $('#schedule-editor')._path = schedulePath;
}

function renderScheduleEditor() {
    const editorDiv = $('#schedule-editor');
    editorDiv.innerHTML = '';
    const days = ['–î—É—à–∞–Ω–±–µ', '–°–µ—à–∞–Ω–±–µ', '–ß–æ—Ä—à–∞–Ω–±–µ', '–ü–∞–Ω“∑—à–∞–Ω–±–µ', '“∂—É–º—ä–∞', '–®–∞–Ω–±–µ'];
    days.forEach(day => {
        let dayHTML = `<div class="glass-card rounded-2xl p-4 flex flex-col">
            <h3 class="font-bold text-lg mb-3">${day}</h3>
            <div class="day-lessons-container space-y-2 flex-grow" data-day="${day}">`;
        const lessons = currentSchedule[day] || [];
        if (lessons.length > 0) {
            lessons.forEach((lesson, index) => {
                const timeText = lesson.startTime && lesson.endTime ? `${lesson.startTime} - ${lesson.endTime}` : (lesson.time || 'N/A');
                // ‚ú® UPDATED: Added draggable attribute and data-index for drag-and-drop
                dayHTML += `<div class="lesson-card bg-white/50 dark:bg-black/20 p-2 rounded-lg flex justify-between items-center" draggable="true" data-index="${index}">
                    <div class="flex-grow cursor-move">
                        <p class="font-semibold text-sm">${lesson.subject}</p>
                        <p class="text-xs opacity-70">${timeText} / ${lesson.aud}</p>
                    </div>
                    <div class="flex gap-1">
                        <button class="icon-btn" onclick="openLessonModal('${day}', ${index})">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="deleteLesson('${day}', ${index})">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
        } else {
            dayHTML += '<p class="text-center text-sm opacity-60 mt-4">–ü–∞—Ä –Ω–µ—Ç</p>';
        }
        dayHTML += `</div>
            <button class="mt-4 w-full bg-blue-500 text-white text-sm font-semibold rounded-lg py-2 hover:bg-blue-600" onclick="openLessonModal('${day}')">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É</button>
        </div>`;
        editorDiv.innerHTML += dayHTML;
    });
    // ‚ú® NEW: Add drag-and-drop event listeners after rendering
    addDragAndDropListeners();
}


// ‚ú® NEW: Drag and Drop functionality
let draggedItem = null;
function addDragAndDropListeners() {
    const lessonCards = document.querySelectorAll('.lesson-card');
    const containers = document.querySelectorAll('.day-lessons-container');

    lessonCards.forEach(card => {
        card.addEventListener('dragstart', (e) => {
            draggedItem = e.target.closest('.lesson-card');
            setTimeout(() => e.target.closest('.lesson-card').classList.add('dragging'), 0);
        });
        card.addEventListener('dragend', () => {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });

    containers.forEach(container => {
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const currentlyDragged = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(currentlyDragged);
            } else {
                container.insertBefore(currentlyDragged, afterElement);
            }
        });
        container.addEventListener('drop', (e) => {
            e.preventDefault();
            const day = container.dataset.day;
            const newOrder = Array.from(container.querySelectorAll('.lesson-card'))
                                .map(card => parseInt(card.dataset.index));
            reorderLessons(day, newOrder);
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.lesson-card:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function reorderLessons(day, newOrderIndices) {
    const originalDaySchedule = [...(currentSchedule[day] || [])];
    if (originalDaySchedule.length === 0) return;

    const reorderedSchedule = newOrderIndices.map(index => originalDaySchedule[index]);
    
    const pathIds = { f: $('#facultySelect').value, c: $('#courseSelect').value, g: $('#groupSelect').value };
    const dayPath = `schedules/${pathIds.f}/${pathIds.c}/${pathIds.g}/${day}`;
    
    db.ref(dayPath).set(reorderedSchedule)
        .then(() => {
            logAction('lesson_reorder', `–ò–∑–º–µ–Ω–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä –¥–ª—è –¥–Ω—è "${day}"`, { –≥—Ä—É–ø–ø–∞: `${pathIds.f}/${pathIds.c}/${pathIds.g}` });
            showToast('–ü–æ—Ä—è–¥–æ–∫ –ø–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
        })
        .catch(err => {
            console.error(err);
            showToast('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –ø–∞—Ä.', 'error');
        });
}


window.openLessonModal = (day, index = -1) => {
    $('#lessonForm').reset();
    $('#editingDay').value = day;
    $('#editingIndex').value = index;

    // ‚ú® UPDATED: Logic for smart placeholders
    if (index > -1) {
        $('#lessonModalTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É (${day})`;
        const lesson = currentSchedule[day][index];
        $('#lessonStartTime').value = lesson.startTime || '';
        $('#lessonEndTime').value = lesson.endTime || '';
        if (lesson.time && !lesson.startTime) {
            const times = lesson.time.split('-');
            $('#lessonStartTime').value = times[0]?.trim() || '';
            $('#lessonEndTime').value = times[1]?.trim() || '';
        }
        $('#lessonAud').value = lesson.aud;
        $('#lessonSubject').value = lesson.subject;
        // Clear placeholders when editing
        $('#lessonAud').placeholder = '–ê—É–¥–∏—Ç–æ—Ä–∏—è';
        $('#lessonSubject').placeholder = '–ü—Ä–µ–¥–º–µ—Ç –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å';
    } else {
        $('#lessonModalTitle').textContent = `–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É (${day})`;
        // Use last added details as placeholders
        $('#lessonAud').placeholder = lastAddedLessonDetails.aud || '–ê—É–¥–∏—Ç–æ—Ä–∏—è';
        $('#lessonSubject').placeholder = lastAddedLessonDetails.subject || '–ü—Ä–µ–¥–º–µ—Ç –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å';
    }
    $('#lessonModal').classList.add('active');
}

function saveLesson(e) {
    e.preventDefault();
    const day = $('#editingDay').value;
    const index = parseInt($('#editingIndex').value);
    const newLesson = {
        startTime: $('#lessonStartTime').value,
        endTime: $('#lessonEndTime').value,
        aud: $('#lessonAud').value,
        subject: $('#lessonSubject').value
    };
    const pathIds = { f: $('#facultySelect').value, c: $('#courseSelect').value, g: $('#groupSelect').value };
    let oldLesson = null;
    if (index > -1) oldLesson = currentSchedule[day][index];
    
    let updatedDaySchedule = Array.isArray(currentSchedule[day]) ? [...currentSchedule[day]] : [];
    if (index > -1) {
        updatedDaySchedule[index] = newLesson;
    } else {
        updatedDaySchedule.push(newLesson);
    }
    const dayPath = `schedules/${pathIds.f}/${pathIds.c}/${pathIds.g}/${day}`;
    db.ref(dayPath).set(updatedDaySchedule)
        .then(() => {
            const type = (index > -1) ? 'lesson_edit' : 'lesson_add';
            const action = (index > -1) ? `–ü–∞—Ä–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞` : `–ü–∞—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞`;
            const details = {
                –≥—Ä—É–ø–ø–∞: `${pathIds.f}/${pathIds.c}/${pathIds.g}`,
                –¥–µ–Ω—å: day,
                ...(oldLesson && { —Å—Ç–∞—Ä–∞—è_–ø–∞—Ä–∞: oldLesson }),
                –Ω–æ–≤–∞—è_–ø–∞—Ä–∞: newLesson
            };
            logAction(type, action, details);

            // ‚ú® UPDATED: Save last added details for next placeholder
            if (index === -1) {
                lastAddedLessonDetails.subject = newLesson.subject;
                lastAddedLessonDetails.aud = newLesson.aud;
            }

            showToast('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            $('#lessonModal').classList.remove('active');
        })
        .catch(err => showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'));
}

window.deleteLesson = (day, index) => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
    const deletedLesson = currentSchedule[day][index];
    let updatedDaySchedule = [...currentSchedule[day]];
    updatedDaySchedule.splice(index, 1);
    const pathIds = { f: $('#facultySelect').value, c: $('#courseSelect').value, g: $('#groupSelect').value };
    const dayPath = `schedules/${pathIds.f}/${pathIds.c}/${pathIds.g}/${day}`;
    db.ref(dayPath).set(updatedDaySchedule)
        .then(() => {
            const type = 'lesson_delete';
            const action = `–ü–∞—Ä–∞ —É–¥–∞–ª–µ–Ω–∞`;
            const details = {
                –≥—Ä—É–ø–ø–∞: `${pathIds.f}/${pathIds.c}/${pathIds.g}`,
                –¥–µ–Ω—å: day,
                —É–¥–∞–ª–µ–Ω–Ω–∞—è_–ø–∞—Ä–∞: deletedLesson
            };
            logAction(type, action, details);
            showToast('–ü–∞—Ä–∞ —É–¥–∞–ª–µ–Ω–∞!');
        })
        .catch(err => showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error'));
}

// --- HIERARCHY MANAGEMENT ---
window.openHierarchyModal = (level) => {
    const modal = $("#hierarchyModal"), list = $("#hierarchyModalList");
    resetHierarchyForm();
    let items = {}, parentPath = 'hierarchy', title = '';
    const pathIds = { f: $("#facultySelect").value, c: $("#courseSelect").value };
    try {
        if (level === 'faculties') {
            title = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞–º–∏';
            items = hierarchy || {};
        } else if (level === 'courses') {
            if (!pathIds.f) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç');
            title = `–ö—É—Ä—Å—ã: ${hierarchy[pathIds.f].name}`;
            items = hierarchy[pathIds.f].courses || {};
            parentPath += `/${pathIds.f}/courses`;
        } else if (level === 'groups') {
            if (!pathIds.c) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å');
            title = `–ì—Ä—É–ø–ø—ã: ${hierarchy[pathIds.f].courses[pathIds.c].name}`;
            items = hierarchy[pathIds.f].courses[pathIds.c].groups || {};
            parentPath += `/${pathIds.f}/courses/${pathIds.c}/groups`;
        }
    } catch (e) {
        showToast(e.message, 'error');
        return;
    }
    currentHierarchyContext = { level, parentPath, pathIds };
    $("#hierarchyModalTitle").textContent = title;
    list.innerHTML = '';
    if (!items || Object.keys(items).length === 0) {
        list.innerHTML = '<p class="text-center opacity-60">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.</p>';
    } else {
        for (const key in items) {
            list.innerHTML += `<li class="flex justify-between items-center p-2 border-b border-[var(--border-color)]">
                <span>${items[key].name} <em class="text-xs opacity-50">(${key})</em></span>
                <div class="flex gap-2">
                    <button class="icon-btn" onclick="startEditHierarchyItem('${key}', '${items[key].name}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                    <button class="icon-btn text-red-500" onclick="deleteHierarchyItem('${key}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
            </li>`;
        }
    }
    modal.classList.add("active");
}

function handleHierarchyFormSubmit(e) {
    e.preventDefault();
    const name = $("#hierarchyItemName").value.trim();
    const id = $("#hierarchyItemId").value.trim();
    const editId = $("#hierarchyEditId").value;
    if (!name || !id) return showToast("–í–≤–µ–¥–∏—Ç–µ ID –∏ –ù–∞–∑–≤–∞–Ω–∏–µ", "error");
    const finalId = editId || id;
    
    // Determine old name for logging
    let oldName = null;
    if (editId) {
        const { level, pathIds } = currentHierarchyContext;
        if (level === 'faculties') oldName = hierarchy[editId]?.name;
        else if (level === 'courses') oldName = hierarchy[pathIds.f]?.courses?.[editId]?.name;
        else if (level === 'groups') oldName = hierarchy[pathIds.f]?.courses?.[pathIds.c]?.groups?.[editId]?.name;
    }

    const type = editId ? 'hierarchy_edit' : 'hierarchy_add';
    const action = editId ? `–≠–ª–µ–º–µ–Ω—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω` : `–≠–ª–µ–º–µ–Ω—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω`;
    const details = {
        —É—Ä–æ–≤–µ–Ω—å: currentHierarchyContext.level,
        id: finalId,
        ...(oldName && { —Å—Ç–∞—Ä–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ: oldName }),
        –Ω–æ–≤–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ: name
    };
    const hierarchyPath = `${currentHierarchyContext.parentPath}/${finalId}`;
    db.ref(hierarchyPath).set({ name })
        .then(() => {
            logAction(type, action, details);
            showToast(`–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ ${editId ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω'}!`);
            resetHierarchyForm();
        })
        .catch(e => showToast(`–û—à–∏–±–∫–∞: ${e.message}`, "error"));
}


window.startEditHierarchyItem = (id, name) => {
    $("#hierarchyEditId").value = id;
    $("#hierarchyItemName").value = name;
    $("#hierarchyItemId").value = id;
    $("#hierarchyItemId").disabled = true;
    $("#hierarchyFormTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç";
    $("#addHierarchyItemBtn").textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
    $("#cancelHierarchyEditBtn").style.display = "block";
}

function resetHierarchyForm() {
    $("#hierarchyForm").reset();
    $("#hierarchyEditId").value = "";
    $("#hierarchyItemId").disabled = false;
    $("#hierarchyFormTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç";
    $("#addHierarchyItemBtn").textContent = "–î–æ–±–∞–≤–∏—Ç—å";
    $("#cancelHierarchyEditBtn").style.display = "none";
}

window.deleteHierarchyItem = (itemId) => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç —ç–ª–µ–º–µ–Ω—Ç –∏ –í–°–ï –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤ –Ω–µ–≥–æ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)!')) return;
    const { level, parentPath, pathIds } = currentHierarchyContext;
    
    let deletedName = itemId;
    try {
        if (level === 'faculties') deletedName = hierarchy[itemId].name;
        else if (level === 'courses') deletedName = hierarchy[pathIds.f].courses[itemId].name;
        else if (level === 'groups') deletedName = hierarchy[pathIds.f].courses[pathIds.c].groups[itemId].name;
    } catch(e) { /* Name not found, use ID */ }
    
    const updates = {};
    const hierarchyPath = `${parentPath}/${itemId}`;
    updates[hierarchyPath] = null;
    if (level === "faculties") updates[`/schedules/${itemId}`] = null;
    else if (level === "courses") updates[`/schedules/${pathIds.f}/${itemId}`] = null;
    else if (level === "groups") updates[`/schedules/${pathIds.f}/${pathIds.c}/${itemId}`] = null;
    
    db.ref().update(updates)
        .then(() => {
            const type = 'hierarchy_delete';
            const action = `–≠–ª–µ–º–µ–Ω—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏ —É–¥–∞–ª–µ–Ω`;
            const details = {
                —É—Ä–æ–≤–µ–Ω—å: level,
                —É–¥–∞–ª–µ–Ω–Ω—ã–π_—ç–ª–µ–º–µ–Ω—Ç: { id: itemId, name: deletedName }
            };
            logAction(type, action, details);
            showToast("–≠–ª–µ–º–µ–Ω—Ç –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã.");
            resetHierarchyForm();
        })
        .catch(e => showToast(`–û—à–∏–±–∫–∞: ${e.message}`, "error"));
}

// --- HISTORY LOGGING ---
function logAction(type, action, details = {}) {
    db.ref('history').push({
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        user: auth.currentUser.email,
        type: type,
        action: action,
        details: details
    });
}

// --- TOAST ---
const showToast = (text, type = "success") => {
    Toastify({
        text,
        duration: 3000,
        gravity: "bottom",
        position: "right",
        style: { background: type === "success" ? "#10b981" : "#ef4444" }
    }).showToast();
};
</script>

</body>
</html>
